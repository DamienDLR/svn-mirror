%
% Copyright (C) 2011 LaTeX3 Project
%

\documentclass{minimal}
\input{regression-test}

\RequirePackage{l3str}

\begin{document}
\START
\AUTHOR{Bruno Le Floch}
\ExplSyntaxOn
\OMIT
\cs_generate_variant:Nn \str_convert:nnn { nno }
\TIMO

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\TEST{str_if_bytes}{
  \str_set:Nn \l_foo_str {abc~#\^^@\^^ff}
  \TYPE { \str_if_bytes:NTF \l_foo_str { TRUE } { \ERROR } }
  % Needs testing with LuaTeX or XeTeX!
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\cs_set:Npn \test_tmp:w #1
  { #10 #11 #12 #13 #14 #15 #16 #17 #18 #19 #1A #1B #1C #1D #1E #1F }
\str_set:Nx \l_foo_str
  { \tl_map_function:nN {0123456789ABCDEF} \test_tmp:w }
\tl_set:Nx \l_all_bytes_tl
  { \exp_args:No \str_convert_input_hex:n { \l_foo_str } }

\TEST{Escaping~hex}{
  \TYPE { \l_all_bytes_tl }
  \tl_set:Nx \l_bar_tl
    { \str_convert_output_hex:n { \l_all_bytes_tl } }
  \TYPE { \l_bar_tl }
  \str_if_eq:xxTF
    { \l_all_bytes_tl }
    { \exp_args:No \str_convert_input_hex:n { \l_bar_tl } }
    { \TRUE } { \ERROR }
}
 % need to test on invalid input

\TEST{Escaping~name}{
  \tl_set:Nx \l_bar_tl
    { \str_convert_output_name:n { \l_all_bytes_tl } }
  \TYPE { \l_bar_tl }
  \str_if_eq:xxTF
    { \l_all_bytes_tl }
    { \exp_args:No \str_convert_input_name:n { \l_bar_tl } }
    { \TRUE } { \ERROR }
}
 % need to test on invalid input

\TEST{Escaping~string}{
  \tl_set:Nx \l_bar_tl
    { \str_convert_output_string:n { \l_all_bytes_tl } }
  \TYPE { \l_bar_tl }
  \str_if_eq:xxTF
    { \l_all_bytes_tl }
    { \exp_args:No \str_convert_input_string:n { \l_bar_tl } }
    { \TRUE } { \ERROR }
}
 % need to test on invalid input

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\TEST{Escaping~url}{
  \tl_set:Nx \l_bar_tl
    { \str_convert_output_url:n { \l_all_bytes_tl } }
  \TYPE { \l_bar_tl }
  \str_if_eq:xxTF
    { \l_all_bytes_tl }
    { \exp_args:No \str_convert_input_url:n { \l_bar_tl } }
    { \TRUE } { \ERROR }
}
 % need to test on invalid input

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\char_set_catcode_other:N \^^83

\TEST{str_set_from_UTF_viii:Nn}{
  \str_set_convert:Nnn \l_tmpa_str { utf8/hex } { c2 83 }
  \str_if_eq:onTF \l_tmpa_str { ^^83 } { \TRUE } { \ERROR }
}

\TEST{str_to_UTF_viii:n}{
  \str_if_eq:xxTF
    { \str_convert:nnn { native } { utf8/hex } { ^^83 } }
    { C2 83 }
    { \TRUE } { \ERROR }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\TEST{iso~encoding}{
  \str_load_encoding:n { iso88592 }
  \str_if_eq:xxTF
    {
      \str_convert:nnn { utf16/hex } { iso88592/hex }
        { 0044 3333 0044 005E 0044 017C 0044 017D 0044 }
    }
    { 44445E44BF44AE44 }
    { \TRUE } { \ERROR }
}

\END
