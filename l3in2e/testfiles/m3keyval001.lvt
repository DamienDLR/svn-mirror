% Copyright (C) 2009 The LaTeX3 Project


\documentclass{minimal}
\input{regression-test}

\RequirePackage{expl3}


\begin{document}
\START
\AUTHOR{Will~Robertson}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Only testing the higher-level
% functionality of this module,
% at this stage at least.     
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST{defined~functions}{
  \declare@command \KV_parse_no_space_removal_no_sanitize:n
  \declare@command \KV_parse_space_removal_no_sanitize:n
  \declare@command \KV_parse_space_removal_sanitize:n
  \declare@command \l_KV_remove_one_level_of_braces_bool
  \declare@command \KV_key_no_value_elt:n
  \declare@command \KV_key_value_elt:nn
}

\TIMO
\cs_set_nopar:Npn \keyval_clist {,a,b,,c,d,,}
\cs_set_nopar:Npn \keyval_clist_spaces {,~,~a~,~b~,~,,~c~,~d~,~,~,,}
\cs_set_nopar:Npn \keyval_plain {,a={1},b={2},,c={3},d={4},,}
\cs_set_nopar:Npn \keyval_plain_spaces {,~,~a~={~1~},~b~=~{~2~},~,,~c~={~3~}~,~d~=~{~4~}~,~,~,,}
\char_make_active:N \,
\char_make_active:N \=
\cs_set_nopar:Npn \keyval_active {,a={1},b={2},,c={3},d={4},,}
\cs_set_nopar:Npn \keyval_active_spaces {,~,~a~={~1~},~b~=~{~2~},~,,~c~={~3~}~,~d~=~{~4~}~,~,~,,}
\char_make_other:N \,
\char_make_other:N \=
\OMIT

\cs_set_nopar:Npn \KV_key_no_value_elt:n #1 { \TYPE { KEY~NO~VAL:~"\tlist_to_str:n {#1}" } }
\cs_set_nopar:Npn \KV_key_value_elt:nn #1#2 { 
  \TYPE { KEY:~"\tlist_to_str:n {#1}"~~~VAL:~"\tlist_to_str:n {#2}" } 
}

\TEST{parse_no_space_removal_no_sanitize}{
  \bool_set_false:N \l_KV_remove_one_level_of_braces_bool
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_clist }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_clist_spaces }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_plain }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_plain_spaces }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_active }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_active_spaces }
  \SEPARATOR
  \bool_set_true:N \l_KV_remove_one_level_of_braces_bool
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_clist }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_clist_spaces }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_plain }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_plain_spaces }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_active }
  \exp_args:No \KV_parse_no_space_removal_no_sanitize:n { \keyval_active_spaces }
}

\TEST{parse_space_removal_no_sanitize}{
  \bool_set_false:N \l_KV_remove_one_level_of_braces_bool
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_clist }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_clist_spaces }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_plain }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_plain_spaces }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_active }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_active_spaces }
  \SEPARATOR
  \bool_set_true:N \l_KV_remove_one_level_of_braces_bool
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_clist }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_clist_spaces }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_plain }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_plain_spaces }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_active }
  \exp_args:No \KV_parse_space_removal_no_sanitize:n { \keyval_active_spaces }
}

\TEST{parse_space_removal_sanitize}{
  \bool_set_false:N \l_KV_remove_one_level_of_braces_bool
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_clist }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_clist_spaces }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_plain }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_plain_spaces }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_active }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_active_spaces }
  \SEPARATOR
  \bool_set_true:N \l_KV_remove_one_level_of_braces_bool
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_clist }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_clist_spaces }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_plain }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_plain_spaces }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_active }
  \exp_args:No \KV_parse_space_removal_sanitize:n { \keyval_active_spaces }
}


\END
