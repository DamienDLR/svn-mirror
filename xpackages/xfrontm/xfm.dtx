% \iffalse
%%
%% (C) Copyright 2001 Frank Mittelbach
%% All rights reserved.
%%
%% Not for general distribution. In its present form it is not allowed
%% to put this package onto CD or an archive without consulting the
%% the authors.
%% 
%    \begin{macrocode}
\def\next#1: #2.dtx,v #3 #4 #5 #6 #7$#8{
%<*dtx>
  \ProvidesFile{#2.dtx}
%</dtx>
%<package>\ProvidesPackage{#2}
%<driver>\ProvidesFile{#2.drv}
  [#4 #3 #8 (#6)]}
\next$Id$
       {multiple marks}
\iffalse
%    \end{macrocode}
%
%<*driver>
 \documentclass{ltxdoc}
%
 \begin{document}
 \DocInput{xfm.dtx}
 \end{document}
\fi
%</driver>
%
% \fi
%
%
% \GetFileInfo{xfm.dtx}
%
% \title{The \textsf{xfm} package\thanks{This file
%         has version number \fileversion, last
%         revised \filedate.}}
% \author{FMi}
% \date{\filedate}
%
%  \maketitle
%
% \tableofcontents
%
%
%
% \section{Intro}
%
%
%    \begin{macrocode}
\RequirePackage{ldcsetup}
\RequirePackage{xtools}
\IgnoreWhiteSpace


\def \queue@if@in@NoTF #1#2{\expandafter \queue@if@in@NnTF
                            \expandafter #1 \expandafter {#2}}

\def \prop@gput@Nco #1#2#3{
  \expandafter\prop@gput@NNn \expandafter #1 
                          \csname #2 \expandafter \endcsname
                          \expandafter { #3 } }

\def \tlp@gput@right@No #1#2 {
  \expandafter \tlp@gput@right@Nn \expandafter #1 \expandafter { #2 }}


\def \queue@map@NN #1#2{
  \let \queue@map@funct@n #2
  \expandafter\queue@map@aux@w #1\queue@elt\q@stop\queue@eelt}
\def \queue@map@aux@w \queue@elt#1\queue@eelt{
  \ifx #1\q@stop \else
    \queue@map@funct@n {#1}
    \expandafter\queue@map@aux@w
  \fi}


%    \end{macrocode}
%
%    \begin{macrocode}


\newcount\xfm@authors

\def\author#1#2{
  \advance\xfm@authors\@ne
  \prop@new@c 
     {xfm@author@\the\xfm@authors}
  \prop@gput@cNn  
     {xfm@author@\the\xfm@authors}
     \xfm@key@name
     {#1}
  \setkeys{xfm}{#2}
}


\define@key{xfm}{address}{
  \prop@gput@ccn  
     {xfm@author@\the\xfm@authors}
     {xfm@key@\@tempa}
     {#1}
}

\let \KV@xfm@email      \KV@xfm@address
\let \KV@xfm@altaddress \KV@xfm@address
\let \KV@xfm@homepage   \KV@xfm@address
\let \KV@xfm@thanks     \KV@xfm@address
\expandafter
\let \csname KV@xfm@thanks2\endcsname     \KV@xfm@address


\tlp@new@Nn\xfm@address@list@tlp{}
\tlp@new@Nn\xfm@authors@list@tlp{}
\tlp@new@Nn\xfm@thanks@list@tlp{}


\tlp@new@Nn\xfm@result@tlp{}
\tlp@new@Nn\xfm@resultii@tlp{}
\tlp@new@Nn\xfm@resultiii@tlp{}
\tlp@new@Nn\xfm@resultiv@tlp{}



% author-prop, key, key-format, marker-counter, marker-prop,   marker-format, target-tlp,
% #1           #2   #3          #4              #5             #6             #7
%
\def\distribute@author@key@NNNNNN #1#2#3#4#5#6#7 {
  \prop@get@NNN
     #1
     #2
     \xfm@result@tlp

%    \end{macrocode}
%    If the key was specified we have a value in |\xfm@result@tlp|,
%    otherwise nothing needs to be done for this key.
%    \begin{macrocode}
  \quark@if@no@value@NF \xfm@result@tlp
     {

      \let\xfm@resultii@tlp\q@no@value
      \prop@map@NN #5 \xfm@find@marker@Nn
      \quark@if@no@value@NT \xfm@resultii@tlp
%    \end{macrocode}
%    
%    Value does not exist, so make new mark:
%    \begin{macrocode}
        {
          \global\advance#4\@ne
          \tlp@gset@No 
             \xfm@resultiv@tlp { \the#4 }

          \tlp@gset@No \xfm@resultii@tlp 
             { \csname mark-\xfm@resultiv@tlp \endcsname }

          \tlp@gput@right@No
             #5
             \xfm@resultii@tlp

          \tlp@gset@No 
             \xfm@resultiii@tlp 
             { \expandafter { \xfm@resultiv@tlp } }
          \tlp@gput@right@No
             \xfm@resultiii@tlp 
             { \expandafter { \xfm@result@tlp } }

          \tlp@gput@right@No
             #5
             { \expandafter { \xfm@resultiii@tlp } }


          \tlp@gput@right@No
             #7
             { \expandafter #3 \xfm@resultiii@tlp  }
        }
%    \end{macrocode}
%    At this point the mark reference is definitely in
%    |\xfm@resultii@tlp| so we can append it to the
%    |\xfm@authors@list@tlp|.
%    \begin{macrocode}

      
      \tlp@gput@right@No
         \xfm@authors@list@tlp
         { \expandafter #6 \expandafter { \xfm@resultiv@tlp } }

     }
}

\def \xfm@find@marker@Nn #1 #2 {
  \tlp@gset@No\xfm@resultiii@tlp{ \@secondoftwo #2 }
  \tlp@gset@No\xfm@resultiv@tlp { \@firstoftwo  #2 }
  \ifx \xfm@result@tlp\xfm@resultiii@tlp
    \tlp@set@Nn\xfm@resultii@tlp{#1}
    \let \prop@map@funct@Nn \@gobbletwo
  \fi
}

\newcount   \xfm@markers@cnt
\prop@new@N \xfm@markers@prop

\newcount   \xfm@thanks@cnt
\prop@new@N \xfm@thanks@prop


% author-prop, key-name, marker-name, target-area
% #1         , #2      , #3         , #4

\def \distribute@author@key@Nnnn #1#2#3#4  {
  \expandafter
  \distribute@author@key@NNNNNN 
    \expandafter
      #1
      \csname xfm@key@#2             \expandafter \endcsname
      \csname xfm@format@key@#2@n    \expandafter \endcsname
      \csname xfm@#3@cnt             \expandafter \endcsname
      \csname xfm@#3@prop            \expandafter \endcsname
      \csname xfm@format@marker@#3@n \expandafter \endcsname
      \csname xfm@#4@list@tlp \endcsname 
}

% author-prop, key-name, target-area
% #1         , #2      , #3

\def \append@author@key@Nnn #1#2#3 {
  \expandafter
  \append@author@key@NNNN
    \expandafter
      #1
      \csname xfm@key@#2             \expandafter \endcsname
      \csname xfm@format@key@#2@n    \expandafter \endcsname
      \csname xfm@#3@list@tlp \endcsname 
} 


% author-prop, key, key-format, target-tlp
% #1           #2   #3          #4        
%
\def \append@author@key@NNNN #1#2#3#4 {
  \prop@get@NNN
     #1
     #2
     \xfm@result@tlp

  \tlp@gput@right@No
     \xfm@authors@list@tlp
     { \expandafter #3 \expandafter { \xfm@result@tlp } }

}


\def\distribute@author@data@N #1 {

  \append@author@key@Nnn #1 {name} {authors}

  \distribute@author@key@Nnnn #1 {address}    {markers} {address}
  \distribute@author@key@Nnnn #1 {altaddress} {markers} {address}
  \distribute@author@key@Nnnn #1 {email}      {markers} {address}
  \distribute@author@key@Nnnn #1 {homepage}   {thanks}  {thanks}
  \distribute@author@key@Nnnn #1 {thanks}     {thanks}  {thanks}
  \distribute@author@key@Nnnn #1 {thanks2}    {thanks}  {thanks}

\show\xfm@authors@list@tlp
\show\xfm@address@list@tlp
\show\xfm@thanks@list@tlp
}


\def\distribute@author@data@n #1 {
  \expandafter 
  \distribute@author@data@N 
     \csname xfm@author@ #1 \endcsname
}


%    \end{macrocode}
%
%
%
%
%    \begin{macrocode}
%    \end{macrocode}
%
%
% \endinput
\endinput
%
% $Log$
% Revision 1.2  2001/04/01 09:24:20  latex3
% now we can do at least author block followed by address block with all
% other data distributed appropriately to whatever area is desired (eg
% thanks area etc.)
%
