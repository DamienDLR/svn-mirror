% \iffalse
%%
%% (C) Copyright 1999-2000 Frank Mittelbach, David Carlisle, Chris Rowley
%% (C) Copyright 2003 Piet van Oostrum, David Kastrup
%% All rights reserved.
%%
%% Not for general distribution. In its present form it is not allowed
%% to put this package onto CD or an archive without consulting the
%% the authors.
%% 
% \fi
%
%    \begin{macrocode}
\def\@tempa#1: #2.dtx,v #3 #4 #5 #6 #7${
  \ProvidesPackage{#2}[#4 #3 #5 #6]}
\@tempa$Id$
%    \end{macrocode}
%
% This package is available for test overwrites that need integration
% into the main packages at some point
%
% Ignore white space in this package.
%    \begin{macrocode}
\IgnoreWhiteSpace
%    \end{macrocode}
%    

%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
% STUFF THAT CHANGES CHRIS' xo-final
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%
%    \begin{macrocode}

\flushbottom


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%changes to xo-final
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftrue %  using Frank's changes built on 1.15








%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% my new xo-final stuff
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

                                % traditional LaTeX marks PvO
\DeclareMarkType{leftmark}
\DeclareMarkType{rightmark}
\def\markboth#1#2{%
  \begingroup
    \let\label\relax \let\index\relax \let\glossary\relax
    \unrestored@protected@xdef\@tempa{#1}%
    \expandafter\@markleft\expandafter{\@tempa}%
    \unrestored@protected@xdef\@tempa{#2}%
    \expandafter\@markright\expandafter{\@tempa}%
  \endgroup
  \if@nobreak\ifvmode\nobreak\fi\fi}
\def\markright#1{%
  \begingroup
    \let\label\relax \let\index\relax \let\glossary\relax
    \unrestored@protected@xdef\@tempa{#1}%
    \expandafter\@markright\expandafter{\@tempa}%
  \endgroup
  \if@nobreak\ifvmode\nobreak\fi\fi}
\def\@markleft#1{\PutMark{leftmark}{#1}}
\def\@markright#1{\PutMark{rightmark}{#1}}
\def\leftmark{\LastMark{leftmark}}
\def\rightmark{\FirstMark{rightmark}}

                                % Traditional LaTeX headers and footers  PvO
\def\@thehead{\@oddhead} % initialization
\def\@thefoot{\@oddfoot}

\def \myfinalpage {
  \if@twoside
    \ifodd\c@page \let\@thehead\@oddhead \let\@thefoot\@oddfoot
         \let\pagebodylefthpos\oddsidemargin
    \else \let\@thehead\@evenhead
       \let\@thefoot\@evenfoot \let\pagebodylefthpos\evensidemargin
    \fi
  \else
  \let\pagebodylefthpos\oddsidemargin
  \fi
    \mbox@addtopage (\pagebodylefthpos, -\headsep)
       {\hbox to \textwidth{\@thehead}}
%    \end{macrocode}
%    
%    \begin{macrocode}
%    Init |\dimen|1,2,3,\ldots as vertical current point per column
%    (don't forget in Chris's (sorry, Don's) universum zero is at the
%    top).
%    \end{macrocode}
%    
%    \begin{macrocode}
  \xor_forall_columns:n{
     \dimen \int_use:N\g_xor_curr_col_int
            \z@
  }
%    \end{macrocode}
%    Now mount all top areas looping through an ordered list of top
%    areas.
%    \begin{macrocode}
  \expandafter\mount@top@areas@loop
      \top@areas
      \relax\relax\relax
%    \end{macrocode}
%    Next mount the text columns.
%    \begin{macrocode}
  \xor_forall_columns:n{

%<*trace>
     \tr@ce{GRID (delta):~ column~\int_use:N\g_xor_curr_col_int t:~
        \tlp_use:c {g_xor_t_delta_col_ \int_use:N\g_xor_curr_col_int _tlp}
        \space used}
%</trace>
     \advance \dimen \int_use:N\g_xor_curr_col_int 
              by %NEEDED!!!!!
              \csname g_xor_t_delta_col_ \int_use:N\g_xor_curr_col_int _tlp\endcsname
     
     \advance \dimen \int_use:N\g_xor_curr_col_int
              \csname g_xor_ht_col_ \int_use:N\g_xor_curr_col_int _dim\endcsname

     \setlength \@tempdima
        {\pagebodylefthpos - \columndisplacement
                           + \columndisplacement * \g_xor_curr_col_int }

     \mbox@addtopage ( \the\@tempdima ,\the\dimen\g_xor_curr_col_int  )
         { \box \csname g_xor_col_ \int_use:N\g_xor_curr_col_int _box \endcsname } 

%<*trace>
     \tr@ce{GRID (delta):~ column~\int_use:N\g_xor_curr_col_int b:~
        \tlp_use:c {g_xor_b_delta_col_ \int_use:N\g_xor_curr_col_int _tlp}
        \space used}
%</trace>
     \advance \dimen \int_use:N\g_xor_curr_col_int 
              by %NEEDED!!!!!
              \csname g_xor_b_delta_col_ \int_use:N\g_xor_curr_col_int _tlp\endcsname
  }
%    \end{macrocode}
%    Then mount the bottom floats.
%    \begin{macrocode}
  \def\col@of@focus{0}               % temp solution see below
  \expandafter\mount@bot@areas@loop
      \bot@areas
      \relax\relax\relax
%    \end{macrocode}
%    
%    Next thing is absolutely temp: mount a marginal area on the right
%    (bottom) to allow footnotes there (this is just for testing).
%    \begin{macrocode}
  \setlength \@tempdima
     {\pagebodylefthpos + \columndisplacement * \g_xor_cols_int }
   \mbox@addtopage ( \the\@tempdima , \textheight )
     { \box \saved@footins } % TEMP FMi
   \setlength \@tempdima       % add footer PvO
     {\textheight + \footskip}
   \mbox@addtopage (\pagebodylefthpos, \@tempdima)
     {\hbox to \textwidth{\@thefoot}}
%    
%    Next thing is absolutely temp: mount a marginal area on the right
%    (bottom) to allow marginal floats there (this is just for testing).
%    \begin{macrocode}
  \expandafter
  \if_meaning:NN \csname g_xor_area_ m1\int_use:N\g_xor_curr_col_int
                          _seq \endcsname  \relax
  \else
    \g_xor_curr_col_int\g_xor_cols_int
%FMi was local, why?
    \int_gincr:N \g_xor_curr_col_int
    \make@area@floats@box {m \int_use:N\g_xor_curr_col_int 1}\@tempboxa
    \setlength \@tempdima
       {\pagebodylefthpos + \columndisplacement * \g_xor_cols_int }
     \mbox@addtopage ( \the\@tempdima , \textheight )
        { \vbox to\textheight{\vfil \unvbox \@tempboxa \vfil }}
  \fi
%
  \ifShowGrid
    \ifdim \pagesetup@grid@point@sep > \z@
      \@tempcnta\textheight
      \@tempcntb\topskip
      \int_add:Nn\@tempcnta {-\@tempcntb}
      \@tempdimb\pagesetup@grid@point@sep
      \@tempcntb\@tempdimb
      \divide\@tempcnta\@tempcntb
      \int_incr:N \@tempcnta

      \setlength \@tempdimb
       {\pagebodylefthpos + \columndisplacement * \g_xor_cols_int
                          - \columnsep }
      \count@\@tempdimb

      \sbox\grid@box{
               \setlength\unitlength{1sp}
               \begin{picture}(0,0)
                 \multiput(0,0)(0,\@tempcntb){\@tempcnta}
                   {\line(1,0){\count@}}
               \end{picture}
               }

      \mbox@addtopage ( \pagebodylefthpos ,\textheight  )
             {  \box\grid@box }
    \fi
  \fi
  \ht\page@box=\topmargin %PvO
}

\newbox\grid@box

\newif\ifShowGrid
\ShowGridtrue

% for tracing only (unchanged)


\def\mbox@addtopage (#1,#2)#3{%
%  \tr@ce{box~being~added~to~page:~at~(#1,~#2) }
  \global \setbox\page@box
    \hbox {
      \unhbox \page@box
      \mbox@put  (#1,#2) {#3}
    }
}




\def\mount@top@areas@loop#1#2#3{
  \ifx#1\relax
  \else
    \mount@top@area#1#2#3
    \expandafter\mount@top@areas@loop
  \fi}


\def\mount@top@area#1#2#3 {
  \make@area@floats@box {#1#2#3}\@tempboxa

  \ifvoid \@tempboxa
  \else

    \setlength \@tempdimb
        { \dimen#2 + \ht\@tempboxa + \dp\@tempboxa }

    \setlength \@tempdima
        {\pagebodylefthpos - \columndisplacement + \columndisplacement * #2 }

    \mbox@addtopage ( \the\@tempdima ,\the\@tempdimb  )
         { \box \@tempboxa } 

    \count@ #2\relax
    \int_add:Nn \count@ {#3}
    \loop
      \int_decr:N \count@
      \dimen \count@ =  \@tempdimb
      \advance\dimen \count@
          \ifnum \csname g_xor_t_floats_col_ \the\count@ _num\endcsname > \z@
            \pagesetup@float@area@sep
          \else
            \pagesetup@float@text@sep
          \fi
    \ifnum #2 < \count@ 
    \repeat

  \fi
}

\def\mount@bot@areas@loop#1#2#3{
  \ifx#1\relax
  \else
    \mount@bot@area#1#2#3
    \expandafter\mount@bot@areas@loop
  \fi}

\def\mount@bot@area#1#2#3 {
  \make@area@floats@box {#1#2#3}\@tempboxa

  \ifvoid \@tempboxa
  \else

    \setlength \@tempdimb
        { \dimen#2 + \ht\@tempboxa + \dp\@tempboxa }

%    \end{macrocode}
%    There are probably much better ways to get the spacing right, the
%    one below is really only a temporary fix: in |\col@of@focus| we
%    remember the last column in which already applied
%    |\pagesetup@float@text@sep|, any additional float area will
%    contribute another |\pagesetup@float@area@sep|
%    instead.\footnote{To make this work it is absolutely necessary
%    that the floats in bot@areas are ordered by column!!! No-good. FIX!!}
%    \begin{macrocode}
    \ifnum \col@of@focus < #2 \relax
      \def\col@of@focus{#2}
      \advance\@tempdimb 
            \pagesetup@float@text@sep
    \else
      \advance\@tempdimb 
            \pagesetup@float@area@sep
    \fi

    \setlength \@tempdima
        {\pagebodylefthpos - \columndisplacement + \columndisplacement * #2 }

    \mbox@addtopage ( \the\@tempdima ,\the\@tempdimb  )
         { \box \@tempboxa } 

%    \end{macrocode}
%    Next loop is actually not necessary as long we keep the
%    restriction that we don't allow partial overlapping float areas, ie we
%    will never mount another float area in the columns that are
%    spanned by the current float area (other than potentially the
%    first and we set this one explicitly).
%    \begin{macrocode}
    \dimen #2 = \@tempdimb
%    \count@ #2\relax
%    \advance\count@ #3\relax
%    \loop
%      \advance\count@\m@ne
%      \dimen \count@ =  \@tempdimb
%    \ifnum #2 < \count@ 
%    \repeat

  \fi
}


% of course \top@areas and \bot@areas should be constructed
% automatically when preparing the \g_xor_areas_used_clist or from the \g_xor_areas_known_clist
% but for now i simply define them here:

\def\top@areas{t13 t12 t22 t32 t11 t21 t31}

\def\bot@areas{b11 b12 b13 b21 b22 b31 b32}


%%%%%%%%%%%%%%%%%%%%%%%%%%%
% next line activates my version (well some of it is activated already
% above) 
%%%%%%%%%%%%%%%%%%%%%%%%%%%
\let\make@page@box\myfinalpage

\fi % end of stuff modifying xo-final 1.15

%    \end{macrocode}
%

\endinput

%
% $Log$
% Revision 1.7  2004/10/03 15:35:59  mittelba
% more cleanup ... tedious ...
%
% Revision 1.6  2004/10/01 21:46:36  mittelba
% many further updates, still a lot to do
%
% Revision 1.5  2004/09/27 20:06:17  mittelba
% in the middle of normalizing to expl3 syntax
%
% Revision 1.4  2004/09/02 15:58:41  mittelba
% stuff moved to xo-final.dtx
%
% Revision 1.3  2003/02/19 14:34:39  kastrup
% Add changes from Piet van Oostrum: compatibility
% marks for LaTeX's default behavior, headers, footers, some fixes.
% Replace \count\z@ with \c@page.
%
% Revision 1.2  2003/02/19 14:16:14  kastrup
% Add changes from Piet van Oostrum: compatibility
% marks for LaTeX's default behavior, headers, footers, some fixes.
%
% Revision 1.1  2001/07/26 19:55:12  latex3
% original web distrib
%
% Revision 1.25  2000/08/11 07:14:23  latex3
% added header
%
% Revision 1.24  2000/08/11 06:49:09  latex3
% untabify
%
% Revision 1.23  2000/08/05 10:01:26  latex3
% ensure that \make@area@floats@box doesn't do any harm to areas not set
% up via \DeclareFloatArea
%
% Revision 1.22  2000/08/04 15:50:31  latex3
% \flushbottom default again
%
% Revision 1.21  2000/08/04 13:58:58  latex3
% \bot@areas need to be ordered by column at the moment!!!!
%
% Revision 1.20  2000/08/04 10:20:09  latex3
% removed old experimental code for grid layout
%
% Revision 1.19  2000/07/22 06:30:50  latex3
% fixed bug in positioning bottom floats
%
% Revision 1.18  2000/07/19 17:12:53  latex3
% introduced float sequence list
%
% Revision 1.17  2000/07/10 19:22:12  latex3
% more grid support
%
% Revision 1.16  2000/07/04 19:48:55  latex3
% experimental stuff for GRIDs
% start writing out columnsizes (unused)
% use \xor_update_this_area_span_cols:n
%
% Revision 1.15  2000/06/29 17:16:59  latex3
% introduced \xor_this_area_setup:o
%
% Revision 1.14  2000/06/26 15:17:26  latex3
% prototype support for \pagesetup@float@area@sep
%
% Revision 1.13  2000/06/16 11:21:07  latex3
% rename \construct@and@test@col@height to \construct@and@test@col@ht
% rename \construct@and@test@col@heights to \construct@and@test@col@hts
% rename \cl@height1 to \@col@ht@1 (etc)
%
% Revision 1.12  2000/06/15 15:22:36  latex3
% implemented new semantics for area names
%
% Revision 1.11  2000/06/13 21:23:03  latex3
% *** empty log message ***
%
% Revision 1.10  2000/05/04 09:21:27  latex3
% urg: \g_xor_this_area_tlp undefined inside the output routine, so captions got
% typeset with whatever was the last \g_xor_this_area_tlp.
%
% Revision 1.9  2000/05/03 18:41:52  latex3
% still overwriting code for xo-final 1.15 ! (not 1.16)
% enabling support for caption templates
%
% Revision 1.8  2000/04/21 19:16:32  latex3
% activate my version of xo-final
%
% Revision 1.7  2000/04/21 19:05:21  latex3
% my version of xo-final mainly
%
% Revision 1.6  2000/04/09 20:02:42  latex3
% first draft of marginpar support
%
% Revision 1.5  2000/03/24 15:34:27  latex3
% version that starts supporting spans (still a hack yet)
%
% Revision 1.4  2000/02/26 18:26:08  david
% code moved to xo-*
%
% Revision 1.3  2000/02/13  21:37:20  latex3
% ooops, my ultrix rcs is too old to guess the comment char correctly
% so we better add explicit \endinput
%
% Revision 1.2  2000/02/13  21:35:25  latex3
% wording
%
% Revision 1.1  2000/02/13  21:34:51  latex3
% Initial revision
%
